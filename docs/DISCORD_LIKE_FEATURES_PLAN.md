# План реализации функционала в стиле Discord

## Анализ текущего состояния

### Что уже есть:
1. **Базовые роли**: OWNER, ADMIN, MEMBER, GUEST (фиксированные enum)
2. **Иерархия ролей**: RoomRoleHierarchy с уровнями приоритета
3. **Переопределения прав на каналах**: для ролей и пользователей
4. **Типы каналов**: TEXT, VOICE, STAGE, ANNOUNCEMENTS, FORUMS, EVENTS
5. **Категории каналов**: ChannelCategory с позиционированием
6. **Базовые права**: ChannelPermission с битовыми масками

### Что отсутствует (в стиле Discord):
1. **Кастомные роли** - создание ролей с настраиваемыми названиями, цветами, иконками
2. **Права на уровне комнаты** - глобальные права для ролей (не только на каналах)
3. **Множественные роли у пользователя** - один пользователь может иметь несколько ролей
4. **Визуальное отображение ролей** - цветные бейджи в списке участников, в сообщениях
5. **Расширенные настройки каналов** - topic, slowmode, NSFW, приватность
6. **Архивация каналов** - скрытие неактивных каналов
7. **Threads** - полноценные ветки обсуждений (частично есть через parent_id)

---

## Архитектурный план

### 1. Система кастомных ролей

#### 1.1 Модель данных
**Новая таблица: `custom_roles`**
```sql
- id: int (PK)
- room_id: int (FK -> rooms.id, CASCADE)
- name: string(128) - название роли
- color: string(7) - hex цвет (#RRGGBB)
- icon: string(512) - путь к иконке (опционально)
- position: int - позиция в списке (для сортировки)
- hoist: bool - показывать отдельно в списке участников
- mentionable: bool - можно упоминать роль
- permissions_mask: int - битовая маска прав на уровне комнаты
- created_at: datetime
- updated_at: datetime
```

**Новая таблица: `user_custom_roles`** (many-to-many)
```sql
- id: int (PK)
- user_id: int (FK -> users.id, CASCADE)
- custom_role_id: int (FK -> custom_roles.id, CASCADE)
- assigned_at: datetime
- UNIQUE(user_id, custom_role_id)
```

**Расширение: `room_permissions` enum**
```python
# Новые права на уровне комнаты (не канала)
MANAGE_ROLES = "manage_roles"
MANAGE_ROOM = "manage_room"
KICK_MEMBERS = "kick_members"
BAN_MEMBERS = "ban_members"
MANAGE_INVITES = "manage_invites"
VIEW_AUDIT_LOG = "view_audit_log"
```

#### 1.2 Логика работы
- Кастомные роли создаются владельцами/админами комнаты
- Роли имеют позицию (position) для сортировки
- Пользователь может иметь несколько кастомных ролей + базовую роль (RoomRole)
- При вычислении прав: базовые права + права всех кастомных ролей (OR)
- Визуально: роли отображаются цветными бейджами в списке участников

### 2. Расширенные настройки каналов

#### 2.1 Расширение модели Channel
**Новые поля:**
```python
- topic: str | None - описание канала
- slowmode_seconds: int - задержка между сообщениями (0 = отключено)
- is_nsfw: bool - пометка 18+
- is_private: bool - приватный канал (виден только участникам с правом VIEW)
- is_archived: bool - архивный канал (скрыт по умолчанию)
- archived_at: datetime | None
- archived_by_id: int | None (FK -> users.id)
```

#### 2.2 Функционал
- **Topic**: отображается в заголовке канала, редактируется админами
- **Slowmode**: ограничение частоты отправки сообщений
- **NSFW**: предупреждение при входе в канал
- **Private channels**: видимость только для определенных ролей/пользователей
- **Архивация**: скрытие неактивных каналов, возможность восстановления

### 3. Улучшения системы прав

#### 3.1 Иерархия вычисления прав
```
1. Базовые права комнаты (RoomRole)
2. Права кастомных ролей (OR всех ролей пользователя)
3. Переопределения на канале (role overwrites)
4. Переопределения на канале (user overwrites) - имеет приоритет
```

#### 3.2 Новые права
- **Room-level permissions**: управление комнатой, ролями, участниками
- **Channel-level permissions**: уже есть, но можно расширить

### 4. Визуальные улучшения

#### 4.1 Отображение ролей
- Цветные бейджи в списке участников
- Сортировка участников по ролям (hoist роли отдельно)
- Отображение ролей в сообщениях (под именем автора)
- Цветной индикатор роли в сайдбаре

#### 4.2 UI для управления ролями
- Drag & drop для изменения позиции ролей
- Цветовой пикер для выбора цвета роли
- Визуальный редактор прав (чекбоксы с группировкой)
- Предпросмотр роли (как она будет выглядеть)

---

## Детальный план реализации

### Фаза 1: Кастомные роли (Backend)

#### Задача 1.1: Модели и миграции
- [ ] Создать модель `CustomRole` с полями: name, color, icon, position, hoist, mentionable, permissions_mask
- [ ] Создать модель `UserCustomRole` (many-to-many)
- [ ] Расширить enum `RoomPermission` (новые права на уровне комнаты)
- [ ] Создать Alembic миграцию для новых таблиц
- [ ] Добавить индексы для производительности

#### Задача 1.2: Схемы (Schemas)
- [ ] `CustomRoleCreate` - создание роли
- [ ] `CustomRoleUpdate` - обновление роли
- [ ] `CustomRoleRead` - чтение роли
- [ ] `CustomRoleReorderPayload` - изменение позиций
- [ ] `UserRoleAssignment` - назначение роли пользователю

#### Задача 1.3: API endpoints
- [ ] `POST /rooms/{slug}/roles` - создать роль
- [ ] `GET /rooms/{slug}/roles` - список ролей
- [ ] `PATCH /rooms/{slug}/roles/{role_id}` - обновить роль
- [ ] `DELETE /rooms/{slug}/roles/{role_id}` - удалить роль
- [ ] `POST /rooms/{slug}/roles/reorder` - изменить порядок
- [ ] `POST /rooms/{slug}/members/{user_id}/roles/{role_id}` - назначить роль
- [ ] `DELETE /rooms/{slug}/members/{user_id}/roles/{role_id}` - снять роль
- [ ] `GET /rooms/{slug}/members/{user_id}/roles` - роли пользователя

#### Задача 1.4: Логика вычисления прав
- [ ] Функция `calculate_user_permissions(user_id, room_id, channel_id=None)`
- [ ] Объединение базовых прав + прав кастомных ролей
- [ ] Применение переопределений на канале
- [ ] Кэширование прав (опционально, для производительности)

#### Задача 1.5: Валидация и безопасность
- [ ] Проверка прав при создании/изменении ролей
- [ ] Защита от создания роли с правами выше текущих
- [ ] Валидация цвета (hex формат)
- [ ] Ограничение количества ролей на комнату

### Фаза 2: Расширенные настройки каналов (Backend)

#### Задача 2.1: Расширение модели Channel
- [ ] Добавить поля: topic, slowmode_seconds, is_nsfw, is_private, is_archived, archived_at, archived_by_id
- [ ] Создать Alembic миграцию
- [ ] Обновить схемы `ChannelCreate`, `ChannelUpdate`, `ChannelRead`

#### Задача 2.2: API для настроек каналов
- [ ] `PATCH /channels/{channel_id}` - обновить настройки (topic, slowmode, nsfw, private)
- [ ] `POST /channels/{channel_id}/archive` - архивировать канал
- [ ] `POST /channels/{channel_id}/unarchive` - восстановить канал
- [ ] `GET /channels/{channel_id}` - вернуть расширенную информацию

#### Задача 2.3: Логика приватных каналов
- [ ] Фильтрация каналов по правам VIEW при получении списка
- [ ] Проверка прав при доступе к каналу
- [ ] Обновление workspace events для скрытия приватных каналов

#### Задача 2.4: Slowmode
- [ ] Middleware/декоратор для проверки slowmode
- [ ] Хранение времени последнего сообщения пользователя в канале
- [ ] Возврат ошибки 429 (Too Many Requests) при превышении лимита

### Фаза 3: Frontend - Управление ролями

#### Задача 3.1: Компоненты UI
- [ ] `CustomRoleManagerDialog` - диалог управления ролями
- [ ] `RoleEditor` - редактор роли (название, цвет, права)
- [ ] `RoleColorPicker` - выбор цвета роли
- [ ] `PermissionEditor` - визуальный редактор прав (группы чекбоксов)
- [ ] `RoleList` - список ролей с drag & drop

#### Задача 3.2: Отображение ролей
- [ ] `RoleBadge` - компонент цветного бейджа роли
- [ ] Обновить `MemberList` - показывать роли участников
- [ ] Обновить `MessageAuthor` - показывать роли в сообщениях
- [ ] Сортировка участников по ролям (hoist)

#### Задача 3.3: Интеграция с store
- [ ] Добавить методы в `workspaceStore`:
  - `createCustomRole(roomSlug, payload)`
  - `updateCustomRole(roomSlug, roleId, payload)`
  - `deleteCustomRole(roomSlug, roleId)`
  - `reorderRoles(roomSlug, roles)`
  - `assignRoleToUser(roomSlug, userId, roleId)`
  - `removeRoleFromUser(roomSlug, userId, roleId)`

#### Задача 3.4: WebSocket события
- [ ] `role_created` - новая роль создана
- [ ] `role_updated` - роль обновлена
- [ ] `role_deleted` - роль удалена
- [ ] `roles_reordered` - порядок ролей изменен
- [ ] `user_role_assigned` - роль назначена пользователю
- [ ] `user_role_removed` - роль снята с пользователя

### Фаза 4: Frontend - Настройки каналов

#### Задача 4.1: Расширение ChannelSettingsDialog
- [ ] Вкладка "Обзор" - topic, описание
- [ ] Вкладка "Права" - уже есть, улучшить UI
- [ ] Вкладка "Настройки" - slowmode, NSFW, приватность
- [ ] Кнопка "Архивировать" для админов

#### Задача 4.2: Отображение каналов
- [ ] Показывать topic в заголовке канала
- [ ] Индикатор NSFW канала
- [ ] Индикатор приватного канала (замочек)
- [ ] Фильтр "Показать архивные" в настройках

#### Задача 4.3: Slowmode UI
- [ ] Индикатор оставшегося времени до следующего сообщения
- [ ] Блокировка кнопки отправки при активном slowmode
- [ ] Таймер обратного отсчета

### Фаза 5: Улучшения и оптимизация

#### Задача 5.1: Производительность
- [ ] Кэширование прав пользователей (Redis/Memory)
- [ ] Оптимизация запросов при загрузке комнаты
- [ ] Lazy loading архивных каналов

#### Задача 5.2: Аудит и логирование
- [ ] Логирование изменений ролей
- [ ] Логирование изменений прав
- [ ] История архивации каналов

#### Задача 5.3: Тестирование
- [ ] Unit тесты для вычисления прав
- [ ] Integration тесты для API ролей
- [ ] E2E тесты для UI управления ролями

---

## Приоритизация задач

### MVP (Минимально жизнеспособный продукт)
1. ✅ Кастомные роли (создание, редактирование, удаление)
2. ✅ Назначение ролей пользователям
3. ✅ Визуальное отображение ролей (цветные бейджи)
4. ✅ Topic для каналов
5. ✅ Slowmode для каналов

### Вторая итерация
6. ✅ Приватные каналы
7. ✅ Архивация каналов
8. ✅ Расширенные права на уровне комнаты
9. ✅ Drag & drop для ролей

### Дополнительные улучшения
10. Иконки для ролей
11. Упоминание ролей (@role)
12. Предпросмотр роли
13. Экспорт/импорт настроек ролей

---

## Технические детали

### Цвета ролей
- Формат: HEX (#RRGGBB)
- Валидация: регулярное выражение `^#[0-9A-Fa-f]{6}$`
- По умолчанию: серый (#99AAB5) или случайный цвет

### Позиционирование ролей
- Позиция: целое число от 0 до N
- Сортировка: по убыванию (роль с position=100 выше role с position=50)
- При создании: автоматически ставится максимальная позиция + 1

### Hoist роли
- Если `hoist = true`: участники с этой ролью показываются отдельной группой
- Сортировка: сначала hoist роли (по position), потом обычные участники

### Множественные роли
- Пользователь может иметь несколько кастомных ролей
- Права объединяются через OR (если есть право хотя бы в одной роли)
- Визуально: все роли отображаются как бейджи

---

## Примеры использования

### Создание роли "Модератор"
```json
POST /rooms/my-room/roles
{
  "name": "Модератор",
  "color": "#FF5733",
  "hoist": true,
  "mentionable": false,
  "permissions": [
    "manage_messages",
    "kick_members",
    "manage_channel"
  ]
}
```

### Назначение роли пользователю
```json
POST /rooms/my-room/members/123/roles/456
```

### Обновление настроек канала
```json
PATCH /channels/789
{
  "topic": "Обсуждение новых фич",
  "slowmode_seconds": 10,
  "is_nsfw": false,
  "is_private": false
}
```

---

## Риски и ограничения

### Производительность
- **Риск**: При большом количестве ролей и пользователей вычисление прав может быть медленным
- **Решение**: Кэширование прав, индексы в БД, оптимизация запросов

### Сложность UI
- **Риск**: Слишком сложный интерфейс управления ролями
- **Решение**: Постепенное раскрытие функций, хорошая документация

### Обратная совместимость
- **Риск**: Изменения могут сломать существующий функционал
- **Решение**: Миграции данных, сохранение старых API endpoints

---

## Метрики успеха

1. ✅ Пользователи могут создавать и настраивать кастомные роли
2. ✅ Роли визуально отображаются в интерфейсе
3. ✅ Система прав работает корректно с кастомными ролями
4. ✅ Настройки каналов (topic, slowmode) работают
5. ✅ Производительность не ухудшилась

---

## Дальнейшие улучшения (не в текущем плане)

1. **Роли с временными ограничениями** - автоматическое снятие роли через N дней
2. **Роли по активности** - автоматическое назначение ролей на основе активности
3. **Шаблоны ролей** - предустановленные наборы ролей для разных типов сообществ
4. **Интеграция с бот-системой** - автоматическое управление ролями через ботов
5. **Аналитика ролей** - статистика использования ролей

