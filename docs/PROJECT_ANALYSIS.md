# Анализ проекта Charge

## Общая информация

**Charge** — это полнофункциональная платформа для общения в реальном времени, похожая на Discord, с поддержкой текстовых и голосовых каналов, прямых сообщений, форумов и событий.

### Технологический стек

**Backend:**
- **FastAPI** (Python 3.11+) — основной веб-фреймворк
- **SQLAlchemy 2.0** — ORM для работы с базой данных
- **Alembic** — миграции базы данных
- **MariaDB** — основная база данных
- **Redis** — кэширование и pub/sub для realtime
- **NATS** — message broker для распределенных систем
- **Uvicorn** — ASGI сервер
- **PyJWT** — аутентификация через JWT токены
- **Passlib** — хеширование паролей (bcrypt)

**Frontend:**
- **React 18** — UI фреймворк
- **TypeScript** — типизация
- **Vite** — сборщик и dev-сервер
- **Zustand** — управление состоянием
- **WebRTC** — голосовая связь (peer-to-peer mesh)
- **React Markdown** — рендеринг markdown в сообщениях
- **i18next** — интернационализация

**Инфраструктура:**
- **Docker Compose** — оркестрация сервисов
- **Nginx** — reverse proxy и статический сервер
- **Coturn** — TURN сервер для WebRTC
- **Certbot** — SSL сертификаты

---

## Архитектура проекта

### Структура базы данных

Проект использует реляционную модель данных с следующими основными сущностями:

#### Пользователи и аутентификация
- **User** — пользователи системы
  - Логин, пароль (bcrypt), отображаемое имя
  - Аватар с версионированием
  - Статус присутствия (online/idle/dnd)

#### Комнаты (Rooms/Серверы)
- **Room** — сервер/комната (аналог Discord сервера)
  - Уникальный slug для URL
  - Иерархия ролей
  - Приглашения

- **RoomMember** — членство пользователя в комнате
  - Роли: OWNER, ADMIN, MEMBER, GUEST
  - Время присоединения

- **CustomRole** — кастомные роли в комнате
  - Цвет, иконка, позиция
  - Битовая маска разрешений
  - Hoist (отдельное отображение), mentionable

- **RoomRoleHierarchy** — иерархия ролей для определения приоритетов

#### Каналы
- **Channel** — каналы внутри комнаты
  - Типы: TEXT, VOICE, STAGE, ANNOUNCEMENTS, FORUMS, EVENTS
  - Категории для группировки
  - Позиционирование
  - Настройки: slowmode, NSFW, приватность, архивация
  - Топик канала

- **ChannelCategory** — категории каналов

- **ChannelRolePermissionOverwrite** — переопределение разрешений для ролей
- **ChannelUserPermissionOverwrite** — переопределение разрешений для пользователей

#### Сообщения
- **Message** — сообщения в текстовых каналах
  - Поддержка тредов (parent_id, thread_root_id)
  - Редактирование и удаление (soft delete)
  - Модерация (moderated_at, moderation_note)
  - Счетчики доставки и прочтения
  - Прикрепления

- **MessageAttachment** — файлы, прикрепленные к сообщениям
  - Хранение на диске (storage_path)
  - Метаданные (размер, тип контента)

- **MessageReaction** — реакции на сообщения (эмодзи)

- **MessageReceipt** — квитанции о доставке и прочтении

- **PinnedMessage** — закрепленные сообщения

#### Голосовые каналы
- **WebRTC Mesh-топология** (текущая реализация)
  - Прямые соединения между участниками
  - Работает для 2-20 участников
  - Проблемы масштабирования при 50+ участниках

#### Форумы
- **ForumPost** — посты в форум-каналах
  - Заголовок, автор, статусы (pinned, archived, locked)
  - Счетчик ответов, последний ответ

- **ForumPostTag** — теги постов
- **ForumChannelTag** — предопределенные теги канала

#### События
- **Event** — события в event-каналах
  - Заголовок, описание, время начала/окончания
  - Организатор, локация, изображение
  - Статусы: scheduled, ongoing, completed, cancelled

- **EventParticipant** — участники событий
  - RSVP статусы: yes, no, maybe, interested

- **EventReminder** — напоминания о событиях

#### Прямые сообщения
- **DirectConversation** — прямые беседы
  - Поддержка 1-on-1 и групповых чатов
  - user_a_id, user_b_id для 1-on-1
  - is_group для групповых

- **DirectConversationParticipant** — участники беседы
  - Никнейм, заметка
  - Время последнего прочтения

- **DirectMessage** — сообщения в прямых беседах
  - Отправитель, получатель (для 1-on-1)
  - Статус прочтения

#### Друзья
- **FriendLink** — связи дружбы
  - Статусы: PENDING, ACCEPTED, DECLINED
  - Направленные связи (requester → addressee)

#### Дополнительные функции
- **AnnouncementCrossPost** — кросс-постинг объявлений в несколько каналов
- **RoomInvitation** — приглашения в комнаты с кодами и сроками действия

---

## Backend API

### Структура API

Все эндпоинты находятся под префиксом `/api`:

#### Аутентификация (`/api/auth`)
- `POST /register` — регистрация нового пользователя
- `POST /login` — получение JWT токена

#### Комнаты (`/api/rooms`)
- `POST /` — создание комнаты
- `GET /{slug}` — получение деталей комнаты с каналами
- `POST /{slug}/channels` — создание канала (admin/owner)
- `DELETE /{slug}/channels/{letter}` — удаление канала

#### Каналы (`/api/channels`)
- `GET /{channel_id}/history` — история сообщений с пагинацией
- Управление настройками каналов
- Управление разрешениями

#### Сообщения (`/api/messages`)
- Управление сообщениями (создание, редактирование, удаление)
- Реакции
- Закрепление сообщений

#### Профиль (`/api/profile`)
- Управление профилем пользователя
- Загрузка аватара

#### Прямые сообщения (`/api/dm`)
- Управление прямыми беседами
- Отправка сообщений

#### Приглашения (`/api/invites`)
- Создание и управление приглашениями
- Присоединение по коду

#### Конфигурация (`/api/config`)
- `GET /webrtc` — конфигурация WebRTC (TURN серверы)
- Другие настройки клиента

#### Метрики (`/metrics`)
- Prometheus-совместимый эндпоинт
- Метрики TURN сервера
- Метрики здоровья системы

### WebSocket эндпоинты

#### `/ws/text/{channel_id}`
- Реалтайм обмен сообщениями в текстовом канале
- Типизация (typing indicators)
- Присутствие пользователей
- Реакции на сообщения
- Keepalive с ping/pong

#### `/ws/signal/{room_slug}`
- WebRTC signaling для голосовых каналов
- Управление участниками
- Состояния (muted, deafened, video)
- Stage режим (поднятие руки, статусы)
- Качество соединения
- Запись (для админов)

#### `/ws/presence`
- Глобальные обновления статуса присутствия
- Для пользователя и его друзей

#### `/ws/direct`
- Обновления прямых сообщений
- Снапшоты бесед

#### `/ws/rooms/{room_slug}`
- Структурные обновления workspace
- Изменения каналов, категорий, ролей

### Система разрешений

#### Уровни разрешений:
1. **Room-level** — разрешения на уровне комнаты
   - Управление ролями, комнатой, участниками
   - Просмотр аудит-лога

2. **Channel-level** — разрешения на уровне канала
   - Просмотр, отправка сообщений
   - Управление сообщениями и каналом
   - Подключение к голосовому каналу
   - Управление stage
   - Публикация объявлений
   - Создание постов в форуме

#### Механизм переопределения:
- Разрешения ролей могут быть переопределены на уровне канала
- Разрешения пользователей могут быть переопределены индивидуально
- Используется битовая маска для эффективного хранения

---

## Frontend архитектура

### Структура приложения

#### Роутинг
- Кастомный роутер на основе hash routing (`#/path`)
- Поддержка навигации через history API
- Маршруты:
  - `/` — основное рабочее пространство
  - `/auth/login` — страница входа
  - `/auth/register` — регистрация
  - `/profile` — профиль пользователя
  - `/dm` — список прямых сообщений
  - `/dm/{id}` — конкретная беседа
  - `/invite/{code}` — присоединение по приглашению

#### Управление состоянием (Zustand)

**workspaceStore** — основное хранилище:
- Комнаты и их детали
- Каналы по комнатам
- Сообщения по каналам
- Присутствие пользователей
- Типизация
- Закрепленные сообщения
- Метаданные истории (пагинация)

#### Компоненты

**Основные:**
- `AppShell` — основной layout с сайдбарами
- `ServerSidebar` — список серверов/комнат
- `ChannelSidebar` — список каналов в комнате
- `ChatView` — область чата с сообщениями
- `VoicePanel` — панель голосовых каналов
- `PresenceList` — список присутствующих пользователей

**Сообщения:**
- `MessageList` — список сообщений с виртуализацией
- `MessageInput` — ввод сообщений с поддержкой markdown
- `PinnedPanel` — панель закрепленных сообщений
- `AnnouncementMessage` — специальный вид для объявлений

**Голос:**
- `VoiceParticipantsPanel` — список участников голосового канала
- `StagePanel` — панель для stage каналов
- `QualityIndicator` — индикатор качества соединения

**Диалоги:**
- `ChannelSettingsDialog` — настройки канала
- `CreateChannelDialog` — создание канала
- `CreateCategoryDialog` — создание категории
- `RoleManagerDialog` — управление ролями
- `CustomRoleManagerDialog` — управление кастомными ролями
- `InviteManagerDialog` — управление приглашениями
- `CreateEventDialog` — создание события
- `CreateForumPostDialog` — создание поста в форуме

**Прямые сообщения:**
- `DirectSidebar` — боковая панель с беседами
- `DirectConversationPanel` — панель беседы

**События:**
- `EventList` — список событий
- `EventCalendar` — календарь событий
- `EventDetail` — детали события

**Форумы:**
- `ForumPostList` — список постов
- `ForumPostView` — просмотр поста

#### WebSocket интеграция

**Хуки для WebSocket:**
- `useChannelSocket` — подключение к текстовому каналу
- `usePresenceSocket` — глобальное присутствие
- `useDirectSocket` — прямые сообщения
- `useWorkspaceSocket` — обновления workspace

**Обработка событий:**
- Автоматическое обновление состояния при получении событий
- Обработка ошибок и переподключение
- Keepalive механизм

#### WebRTC голосовая связь

**VoiceClient** (`frontend/src/webrtc/VoiceClient.ts`):
- Управление WebRTC соединениями
- Mesh-топология (прямые соединения между участниками)
- Поддержка множественных peer connections
- Автоматическое переподключение
- Мониторинг качества соединения
- Управление аудио потоками (mute, deafen)
- Поддержка видео (экспериментально)
- Screen sharing (экспериментально)

**Ограничения:**
- Работает хорошо для 2-10 участников
- Начинаются проблемы при 20+ участниках
- Не масштабируется до 50+ участников

**Планы масштабирования:**
- Переход на SFU (Selective Forwarding Unit) архитектуру
- Использование Mediasoup или аналогичного решения
- Поддержка 100+ участников

---

## Realtime система

### Архитектура

Проект использует гибридный подход для realtime обновлений:

1. **In-memory менеджеры** (для одного инстанса):
   - ChannelManager — управление подключениями к каналам
   - PresenceManager — статусы присутствия
   - TypingManager — индикаторы типизации
   - VoiceSignalManager — WebRTC signaling

2. **Redis + NATS** (для масштабирования):
   - Redis pub/sub для синхронизации между инстансами
   - NATS для распределенных событий
   - Транспортный слой в `charge.realtime.transport`

### Менеджеры

**ChannelManager:**
- Управление WebSocket подключениями к каналам
- Broadcast сообщений всем подключенным клиентам
- Автоматическая очистка при отключении

**PresenceManager:**
- Отслеживание присутствия пользователей в каналах
- Снапшоты присутствующих
- События join/leave

**TypingManager:**
- Индикаторы "печатает..."
- Таймауты для автоматической очистки
- Снапшоты активных типизаций

**VoiceSignalManager:**
- Управление участниками голосовых каналов
- Relay WebRTC signaling (offer/answer/ICE candidates)
- Управление состояниями (muted, deafened, video)
- Stage режим (поднятие руки, статусы)
- Мониторинг качества соединения
- Запись (для админов)

---

## Безопасность

### Аутентификация
- JWT токены с настраиваемым временем жизни
- Хеширование паролей через bcrypt
- Bearer token в заголовках или query параметрах

### Авторизация
- Проверка членства в комнате перед доступом к каналам
- Проверка разрешений для действий
- Иерархия ролей для определения приоритетов

### Валидация
- Pydantic схемы для валидации входных данных
- Ограничения длины сообщений
- Проверка типов каналов
- Slowmode для каналов

### CORS
- Настраиваемые разрешенные origins
- Поддержка regex для поддоменов
- Credentials для cookies

---

## DevOps и развертывание

### Docker Compose

**Сервисы:**
- `api` — FastAPI backend
- `db` — MariaDB база данных
- `frontend` — Nginx с статическими файлами
- `redis` — Redis для кэширования
- `nats` — NATS message broker
- `turn` — Coturn TURN сервер
- `certbot` — обновление SSL сертификатов

### Миграции
- Alembic для управления схемой БД
- Автоматическое применение при старте контейнера
- Версионирование миграций

### Мониторинг
- Prometheus метрики на `/metrics`
- Health check на `/health`
- TURN health probe (`app.services.turn_health`)
- Логирование через стандартный Python logging

### Конфигурация
- Переменные окружения через `.env` и `.env.local`
- Pydantic Settings для валидации конфигурации
- Безопасные дефолты в репозитории

---

## Тестирование

### Backend тесты
- `pytest` для unit и integration тестов
- Тесты API эндпоинтов
- Тесты WebSocket соединений
- Тесты разрешений
- Тесты схем данных

### Frontend тесты
- `vitest` для unit тестов
- `@testing-library/react` для компонентов
- Тесты реакций на сообщения
- Тесты закрепленных сообщений

---

## Документация

### Техническая документация
- `CURRENT_VOICE_ARCHITECTURE.md` — текущая архитектура голоса
- `SCALING_TO_100_PLUS_PARTICIPANTS.md` — план масштабирования
- `SCALING_QUICK_START.md` — быстрый старт для масштабирования
- `SFU_DEFERRED.md` — отложенные задачи SFU
- Различные планы и чеклисты для функций

### API документация
- Автоматическая генерация через FastAPI
- Доступна на `/docs` (Swagger UI)
- OpenAPI спецификация

---

## Реализованные функции

### ✅ Полностью реализовано

1. **Аутентификация и авторизация**
   - Регистрация и вход
   - JWT токены
   - Управление профилем

2. **Комнаты (Серверы)**
   - Создание и управление комнатами
   - Приглашения с кодами
   - Роли и разрешения
   - Кастомные роли

3. **Текстовые каналы**
   - Создание и управление каналами
   - Категории каналов
   - Реалтайм обмен сообщениями
   - Редактирование и удаление сообщений
   - Реакции на сообщения
   - Закрепленные сообщения
   - Треды (ответы на сообщения)
   - Прикрепления файлов
   - Markdown в сообщениях
   - Типизация (typing indicators)
   - Присутствие пользователей
   - Slowmode
   - NSFW флаг
   - Приватные каналы
   - Архивация каналов

4. **Голосовые каналы**
   - WebRTC mesh-топология
   - Одновременное общение с несколькими участниками (до 20)
   - Mute/Deafen
   - Управление громкостью других участников
   - Мониторинг качества соединения
   - TURN сервер для NAT traversal
   - Stage каналы (поднятие руки, статусы)

5. **Прямые сообщения**
   - 1-on-1 беседы
   - Групповые беседы
   - Реалтайм обмен сообщениями
   - Статусы прочтения

6. **Друзья**
   - Система запросов в друзья
   - Статусы дружбы

7. **Форумы**
   - Создание постов в форум-каналах
   - Теги постов
   - Модерация постов

8. **События**
   - Создание событий в event-каналах
   - Участники и RSVP
   - Напоминания о событиях

9. **Объявления**
   - Кросс-постинг в несколько каналов

10. **UI/UX**
    - Темная/светлая тема
    - Адаптивный дизайн
    - Ресайзабельные сайдбары
    - Command palette (Ctrl+K)
    - Toast уведомления
    - Обработка ошибок
    - Offline индикатор

11. **Интернационализация**
    - Поддержка i18n (русский/английский)

### ⚠️ Частично реализовано

1. **Голосовые каналы**
   - Работает для малых групп (2-20 участников)
   - Проблемы масштабирования для больших групп
   - Планируется переход на SFU архитектуру

2. **Видео**
   - Базовая поддержка в коде
   - Не полностью протестировано

3. **Screen sharing**
   - Базовая поддержка в коде
   - Не полностью протестировано

### ❌ Запланировано, но не реализовано

1. **SFU архитектура для голоса**
   - Масштабирование до 100+ участников
   - См. `SCALING_TO_100_PLUS_PARTICIPANTS.md`

2. **Дополнительные функции**
   - Расширенная модерация
   - Аудит-лог
   - Боты и интеграции
   - Видео звонки (полноценная поддержка)

---

## Производительность

### Текущие показатели

**Голосовые каналы (Mesh):**
- 2-10 участников: ✅ Отлично
- 10-20 участников: ⚠️ Работает, но с проблемами
- 20+ участников: ❌ Не работает

**Текстовые каналы:**
- Поддержка больших объемов сообщений
- Виртуализация списка сообщений
- Пагинация истории

**База данных:**
- Индексы на ключевых полях
- Оптимизированные запросы
- Connection pooling

### Оптимизации

1. **Frontend:**
   - Виртуализация длинных списков (`@tanstack/react-virtual`)
   - Мемоизация компонентов
   - Ленивая загрузка компонентов

2. **Backend:**
   - Connection pooling для БД
   - Кэширование через Redis
   - Асинхронная обработка

3. **Realtime:**
   - Эффективный broadcast через менеджеры
   - Минимизация пересылки данных
   - Keepalive для WebSocket

---

## Известные ограничения

1. **Масштабирование голоса:**
   - Mesh-топология не масштабируется выше 20 участников
   - Требуется переход на SFU

2. **База данных:**
   - Один инстанс MariaDB (нет репликации)
   - Нет шардинга

3. **Realtime:**
   - In-memory менеджеры работают только для одного инстанса
   - Redis/NATS используются, но не полностью интегрированы

4. **Файлы:**
   - Локальное хранение (нет S3/объектного хранилища)
   - Нет CDN для статики

---

## Планы развития

1. **SFU для голоса** — приоритет #1
2. **Улучшение масштабируемости** — горизонтальное масштабирование
3. **Дополнительные функции** — боты, интеграции
4. **Улучшение производительности** — оптимизация запросов, кэширование
5. **Мониторинг и аналитика** — расширенные метрики, дашборды

---

## Заключение

Проект Charge представляет собой зрелое решение для общения в реальном времени с широким набором функций. Основные компоненты реализованы и работают стабильно. Главное ограничение — масштабирование голосовых каналов, которое планируется решить через переход на SFU архитектуру.

Архитектура проекта хорошо структурирована, код следует best practices, есть тесты и документация. Проект готов к использованию для малых и средних групп пользователей, с планами масштабирования для больших групп.



