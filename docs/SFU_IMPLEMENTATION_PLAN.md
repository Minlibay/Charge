# План реализации SFU для проекта Charge

## Обзор

Реализация SFU (Selective Forwarding Unit) на базе Mediasoup для масштабирования голосовых каналов до 100+ участников.

## Архитектура

```
┌─────────┐         ┌──────────────┐         ┌─────────┐
│ Client  │◄───────►│  SFU Server  │◄───────►│ Client  │
│         │ WebRTC  │ (Mediasoup)  │ WebRTC  │         │
└─────────┘         └──────┬───────┘         └─────────┘
                            │
                            │ Signaling
                            ▼
                    ┌──────────────┐
                    │ FastAPI      │
                    │ (Current)    │
                    └──────────────┘
```

## Этапы реализации

### Этап 1: Подготовка SFU сервера (2-3 дня)

#### Задача 1.1: Создание структуры SFU сервера
- [ ] Создать директорию `sfu-server/`
- [ ] Инициализировать Node.js проект
- [ ] Установить зависимости (mediasoup, express, ws)
- [ ] Настроить TypeScript (опционально)

#### Задача 1.2: Базовая реализация Mediasoup сервера
- [ ] Создать основной сервер файл
- [ ] Настроить Mediasoup worker
- [ ] Реализовать управление комнатами
- [ ] Реализовать WebSocket для signaling

#### Задача 1.3: Docker контейнер для SFU
- [ ] Создать Dockerfile для SFU
- [ ] Настроить docker-compose.yml
- [ ] Настроить переменные окружения
- [ ] Протестировать запуск

### Этап 2: Интеграция с бэкендом (2-3 дня)

#### Задача 2.1: SFU Manager сервис
- [ ] Создать `backend/app/services/sfu_manager.py`
- [ ] Реализовать REST API клиент для SFU
- [ ] Реализовать создание/удаление комнат
- [ ] Реализовать получение статуса комнат

#### Задача 2.2: Обновление VoiceSignalManager
- [ ] Добавить поддержку SFU режима
- [ ] Добавить feature flag для SFU
- [ ] Интегрировать SFU Manager
- [ ] Обновить signaling логику

#### Задача 2.3: API endpoints для SFU
- [ ] `POST /api/voice/rooms/{room_slug}/sfu/create`
- [ ] `DELETE /api/voice/rooms/{room_slug}/sfu`
- [ ] `GET /api/voice/rooms/{room_slug}/sfu/status`
- [ ] Обновить конфигурацию для SFU

### Этап 3: Обновление клиента (3-4 дня)

#### Задача 3.1: Рефакторинг VoiceClient
- [ ] Создать интерфейс `IVoiceClient`
- [ ] Разделить на `MeshVoiceClient` и `SFUVoiceClient`
- [ ] Создать фабрику для выбора типа клиента
- [ ] Сохранить обратную совместимость

#### Задача 3.2: Реализация SFUVoiceClient
- [ ] Подключение к SFU через WebRTC
- [ ] Управление producer (исходящий поток)
- [ ] Управление consumers (входящие потоки)
- [ ] Обработка signaling от SFU

#### Задача 3.3: Интеграция с UI
- [ ] Обновить `useVoiceConnection` hook
- [ ] Добавить определение возможностей SFU
- [ ] Обновить компоненты для работы с SFU
- [ ] Добавить индикаторы SFU режима

### Этап 4: Тестирование и оптимизация (2-3 дня)

#### Задача 4.1: Базовое тестирование
- [ ] Тест с 2 участниками
- [ ] Тест с 5 участниками
- [ ] Тест с 10 участниками
- [ ] Проверка стабильности соединений

#### Задача 4.2: Нагрузочное тестирование
- [ ] Тест с 20 участниками
- [ ] Тест с 50 участниками
- [ ] Тест с 100 участниками
- [ ] Мониторинг ресурсов

#### Задача 4.3: Оптимизация
- [ ] Настройка параметров Mediasoup
- [ ] Оптимизация битрейта
- [ ] Настройка буферов
- [ ] Оптимизация памяти

### Этап 5: Развертывание (1-2 дня)

#### Задача 5.1: Подготовка к продакшену
- [ ] Настройка мониторинга
- [ ] Настройка логирования
- [ ] Создание документации
- [ ] Настройка резервирования

#### Задача 5.2: Постепенное развертывание
- [ ] Feature flag для включения SFU
- [ ] Пилотное тестирование на тестовых комнатах
- [ ] Мониторинг метрик
- [ ] Постепенный rollout

## Детальные инструкции

### Этап 1: Подготовка SFU сервера

#### Шаг 1.1: Создание структуры проекта

```bash
# Создать директорию
mkdir sfu-server
cd sfu-server

# Инициализировать Node.js проект
npm init -y

# Установить зависимости
npm install mediasoup express ws cors dotenv
npm install --save-dev @types/node @types/express @types/ws typescript ts-node nodemon

# Создать структуру
mkdir src
mkdir src/routers
mkdir src/rooms
mkdir src/transports
```

#### Шаг 1.2: Базовая конфигурация

Создать файлы:
- `package.json` - зависимости и скрипты
- `tsconfig.json` - конфигурация TypeScript
- `.env.example` - пример переменных окружения
- `src/index.ts` - основной файл сервера

#### Шаг 1.3: Реализация Mediasoup сервера

Основные компоненты:
- Worker manager для управления Mediasoup workers
- Room manager для управления комнатами
- WebSocket server для signaling
- REST API для управления

### Этап 2: Интеграция с бэкендом

#### Шаг 2.1: SFU Manager

Создать сервис для взаимодействия с SFU сервером:
- HTTP клиент для REST API SFU
- Методы для создания/удаления комнат
- Методы для получения статуса

#### Шаг 2.2: Обновление конфигурации

Добавить настройки SFU в `backend/app/config.py`:
- URL SFU сервера
- Feature flags
- Таймауты и лимиты

### Этап 3: Обновление клиента

#### Шаг 3.1: Рефакторинг

Создать общий интерфейс и разделить на два класса:
- `MeshVoiceClient` - текущая реализация
- `SFUVoiceClient` - новая реализация для SFU

#### Шаг 3.2: SFU клиент

Реализовать подключение к SFU:
- WebSocket для signaling
- WebRTC для медиа
- Управление producers/consumers

## Переменные окружения

### SFU Server (.env)
```env
# Mediasoup
MEDIASOUP_NUM_WORKERS=2
MEDIASOUP_WORKER_BIN=/usr/local/bin/mediasoup-worker
MEDIASOUP_WORKER_LOG_LEVEL=warn

# Server
SFU_HOST=0.0.0.0
SFU_PORT=3001
SFU_ANNOUNCED_IP=45.144.66.105

# RTP
SFU_RTC_MIN_PORT=40000
SFU_RTC_MAX_PORT=49999

# WebSocket
SFU_WS_PORT=3001

# CORS
SFU_CORS_ORIGIN=http://localhost:80,https://charvi.ru
```

### Backend (.env)
```env
# SFU Integration
SFU_ENABLED=true
SFU_SERVER_URL=http://sfu:3001
SFU_API_KEY=your-secret-key
SFU_FEATURE_FLAG_ENABLED=true
```

## Порты и сеть

### Новые порты
- `3001` - SFU REST API
- `3001` - SFU WebSocket
- `40000-49999` - RTP порты для медиа

### Обновление docker-compose.yml
Добавить сервис `sfu` с необходимыми портами и volumes.

## Мониторинг

### Метрики для отслеживания
- Количество активных комнат
- Количество участников на комнату
- Использование CPU/памяти SFU
- Пропускная способность сети
- Задержка обработки медиа
- Количество ошибок соединений

### Логирование
- Создание/удаление комнат
- Подключение/отключение участников
- Ошибки WebRTC
- Проблемы с медиа

## Тестирование

### Сценарии тестирования
1. **Базовое соединение**: 2 участника
2. **Малая группа**: 5 участников
3. **Средняя группа**: 10-20 участников
4. **Большая группа**: 50+ участников
5. **Стресс-тест**: 100+ участников

### Критерии успеха
- ✅ Все участники слышат друг друга
- ✅ CPU клиента < 10%
- ✅ Память клиента < 100MB
- ✅ Задержка < 200ms
- ✅ Стабильность > 99%

## Откат

### План отката
1. Отключить feature flag для SFU
2. Вернуться к mesh-топологии
3. Остановить SFU сервер
4. Мониторинг стабильности

### Резервирование
- Поддержка обеих архитектур одновременно
- Автоматический fallback на mesh при проблемах с SFU
- Мониторинг и алерты

## Временная оценка

- **Этап 1**: 2-3 дня
- **Этап 2**: 2-3 дня
- **Этап 3**: 3-4 дня
- **Этап 4**: 2-3 дня
- **Этап 5**: 1-2 дня

**Итого**: 10-15 дней (2-3 недели)

## Риски и митигация

### Риск 1: Сложность интеграции
- **Митигация**: Постепенная реализация, тестирование на каждом этапе

### Риск 2: Производительность SFU
- **Митигация**: Нагрузочное тестирование, оптимизация параметров

### Риск 3: Проблемы с сетью
- **Митигация**: Правильная настройка портов, мониторинг

### Риск 4: Совместимость браузеров
- **Митигация**: Тестирование на всех основных браузерах

## Следующие шаги

1. Начать с Этапа 1 (создание SFU сервера)
2. Тестировать каждый этап отдельно
3. Интегрировать постепенно
4. Мониторить метрики

