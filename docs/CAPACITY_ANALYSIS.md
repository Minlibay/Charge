# Анализ пропускной способности проекта Charge

## Конфигурация сервера

- **CPU**: 2 ядра
- **RAM**: 8 GB
- **Сервер**: Uvicorn (ASGI) - 1 worker (по умолчанию)
- **База данных**: MariaDB с пулом соединений (pool_size=10, max_overflow=20)
- **Кэш/PubSub**: Redis + NATS

## Типы подключений

Проект использует несколько типов WebSocket подключений:

1. **Presence** (`/ws/presence`) - обновления статуса пользователей
2. **Direct Messages** (`/ws/direct`) - прямые сообщения
3. **Workspace Updates** (`/ws/rooms/{room_slug}`) - обновления структуры workspace
4. **Text Channels** (`/ws/text/{channel_id}`) - текстовые каналы (сообщения, реакции, typing)
5. **Voice Signaling** (`/ws/signal/{room_slug}`) - WebRTC сигналинг для голосовой связи

## Оценка ресурсов на подключение

### Память
- **WebSocket подключение**: ~50-100 KB на подключение (буферы, состояние)
- **Дополнительные структуры данных**: ~10-20 KB (менеджеры подключений, кэш)
- **Итого на подключение**: ~70-120 KB

### CPU
- **Простой WebSocket**: минимальная нагрузка (keepalive ping/pong каждые 15-30 сек)
- **Активное подключение** (сообщения): ~0.1-0.5% CPU на подключение при активной переписке
- **WebRTC signaling**: выше нагрузка из-за обработки SDP/ICE кандидатов

### База данных
- **Пул соединений**: максимум 30 соединений (10 базовых + 20 overflow)
- **Соединения используются кратковременно** (не держатся на время WebSocket сессии)
- **Ограничение**: ~30 одновременных запросов к БД

## Расчет пропускной способности

### По памяти (8 GB RAM)

**Доступная память для приложения**: ~6 GB (с учетом ОС, БД, Redis, NATS)

**WebSocket подключения**:
- 6 GB / 100 KB = **~60,000 подключений** (теоретический максимум)

**Реальная оценка** (с учетом других процессов):
- ~4 GB для приложения
- 4 GB / 100 KB = **~40,000 подключений**

### По CPU (2 ядра)

**Простой WebSocket** (keepalive только):
- 2 CPU × 1000 подключений на CPU = **~2,000 подключений** (CPU не будет узким местом)

**Активные подключения** (регулярные сообщения):
- При 0.5% CPU на подключение: 200% / 0.5% = **~400 активных подключений**

**Смешанная нагрузка** (80% простых, 20% активных):
- Простые: 40,000 × 0.8 = 32,000 (CPU: ~0.1%)
- Активные: 40,000 × 0.2 = 8,000 (CPU: ~40%)
- **Итого: ~40,000 подключений** (CPU загружен на ~40%)

### По базе данных (30 соединений)

**Критическое ограничение**: пул БД поддерживает только 30 одновременных запросов.

**Сценарии использования БД**:
- Подключение к WebSocket: 1 запрос (проверка прав, загрузка истории)
- Отправка сообщения: 1-2 запроса (сохранение + broadcast)
- Реакция: 1-2 запроса
- Typing indicator: минимальная нагрузка (Redis/NATS)

**Оценка**:
- При 30 соединениях БД и среднем времени запроса 10-50ms
- Пропускная способность: **~600-3000 запросов/сек**
- При активной переписке (1 сообщение в 10 сек на пользователя):
  - 600 запросов/сек / 0.1 запросов/сек = **~6,000 активных пользователей**

### По file descriptors

**Лимит по умолчанию**: обычно 1024-4096 на процесс
**Рекомендуемый лимит**: 65,536

**WebSocket требует**: 1 file descriptor на подключение

**Оценка**: При лимите 4096: **~4,000 подключений** (может быть узким местом)

## Итоговые оценки

### Консервативная оценка (реальная практика)

**Одновременных WebSocket подключений**: **~3,000-5,000**

**Ограничивающие факторы**:
1. ⚠️ **File descriptors** (4096 по умолчанию) - **критично**
2. ⚠️ **База данных** (30 соединений) - при активной переписке
3. ✅ **Память** (8 GB) - не критично до ~40,000
4. ✅ **CPU** (2 ядра) - не критично для простых подключений

### Оптимистичная оценка (с оптимизацией)

**Одновременных WebSocket подключений**: **~10,000-15,000**

**Требуется**:
1. Увеличить лимит file descriptors до 65,536
2. Оптимизировать использование пула БД
3. Использовать больше workers (если поддерживается горизонтальное масштабирование)

### Сценарии использования

#### Сценарий 1: Легкая нагрузка (большинство пользователей онлайн, но неактивны)
- **Подключений**: 5,000-10,000
- **Активных пользователей** (отправляют сообщения): 500-1,000
- **CPU**: ~20-30%
- **RAM**: ~1-2 GB
- **БД**: ~5-10 соединений

#### Сценарий 2: Средняя нагрузка (активная переписка)
- **Подключений**: 3,000-5,000
- **Активных пользователей**: 1,000-2,000
- **CPU**: ~50-70%
- **RAM**: ~1.5-2.5 GB
- **БД**: ~15-25 соединений

#### Сценарий 3: Высокая нагрузка (пиковая активность)
- **Подключений**: 2,000-3,000
- **Активных пользователей**: 2,000-3,000
- **CPU**: ~80-100%
- **RAM**: ~2-3 GB
- **БД**: ~25-30 соединений (близко к лимиту)

## Рекомендации по оптимизации

### Критичные (для увеличения пропускной способности)

1. **Увеличить лимит file descriptors**
   ```bash
   # В Dockerfile или docker-compose.yml
   ulimit -n 65536
   ```

2. **Настроить пул соединений БД** (уже оптимизирован: pool_size=10, max_overflow=20)
   - Рассмотреть увеличение до pool_size=20, max_overflow=40 при необходимости

3. **Использовать несколько workers Uvicorn** (если поддерживается)
   ```bash
   uvicorn app.main:app --workers 2 --host 0.0.0.0 --port 8000
   ```
   ⚠️ **Внимание**: WebSocket state должен быть shared через Redis/NATS

### Средние приоритеты

4. **Мониторинг метрик**
   - `realtime_active_connections` - количество активных WebSocket
   - Использование пула БД
   - File descriptors usage

5. **Оптимизация запросов к БД**
   - Использовать `selectinload`/`joinedload` для избежания N+1
   - Кэширование частых запросов

6. **Rate limiting**
   - Ограничить частоту сообщений на пользователя
   - Защита от злоупотреблений

### Долгосрочные

7. **Горизонтальное масштабирование**
   - Несколько инстансов API
   - Load balancer с sticky sessions или shared state
   - Redis/NATS для синхронизации между инстансами (уже реализовано)

8. **Оптимизация памяти**
   - Сжатие WebSocket сообщений
   - Очистка неактивных подключений

## Выводы

**Текущая конфигурация (2 CPU, 8 GB RAM) может поддерживать**:

- ✅ **3,000-5,000 одновременных WebSocket подключений** (консервативно)
- ✅ **10,000-15,000 подключений** (с оптимизацией file descriptors и настройками)

**Основные ограничения**:
1. File descriptors (4096 по умолчанию) - **самое критичное**
2. База данных (30 соединений) - при очень активной переписке
3. CPU - только при очень высокой активности (>80% пользователей активно пишут)

**Рекомендация**: Начать с **3,000-5,000 пользователей** и мониторить метрики. При необходимости увеличить лимиты и оптимизировать.

