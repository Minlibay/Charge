# Текущая архитектура голосовых каналов

## ✅ Уже реализовано: Множественные одновременные соединения

### Как это работает сейчас:

**Один человек МОЖЕТ общаться с несколькими участниками одновременно!**

#### Архитектура (Mesh-топология):

```
Участник 1 ←→ Участник 2
    ↕           ↕
Участник 3 ←→ Участник 4
    ↕
Участник 5
```

Каждый участник подключается **напрямую** к каждому другому участнику через WebRTC.

### Технические детали:

1. **Множественные Peer Connections**:
   ```typescript
   // VoiceClient.ts
   private peers = new Map<number, PeerEntry>(); // Хранит соединения со всеми участниками
   ```

2. **Автоматическое создание соединений**:
   ```typescript
   // При получении списка участников
   remoteIds.forEach((id) => {
     void this.ensurePeerConnection(id); // Создает соединение с каждым
   });
   ```

3. **Хранение всех потоков**:
   ```typescript
   // Store хранит потоки от всех участников
   voiceRemoteStreams: Record<number, MediaStream | null>
   ```

4. **Воспроизведение всех потоков**:
   - Каждый участник отображается в UI
   - Каждый имеет свой `VoiceParticipantRow` компонент
   - Каждый воспроизводит свой аудио поток независимо

### Пример работы:

**Сценарий**: В комнате 5 участников (A, B, C, D, E)

- **Участник A**:
  - Создает 4 соединения (к B, C, D, E)
  - Отправляет свой аудио поток всем 4 участникам
  - Получает и воспроизводит аудио от всех 4 участников
  - **Результат**: A слышит B, C, D, E одновременно, и они слышат A

- **Участник B**:
  - Создает 4 соединения (к A, C, D, E)
  - Отправляет свой аудио поток всем 4 участникам
  - Получает и воспроизводит аудио от всех 4 участников
  - **Результат**: B слышит A, C, D, E одновременно, и они слышат B

И так далее для всех участников.

### Текущие возможности:

✅ **Одновременное общение с несколькими участниками** - РАБОТАЕТ
- 1 человек может общаться с 5, 10, 20+ участниками
- Все слышат всех (если не muted/deafened)

✅ **Двусторонняя связь** - РАБОТАЕТ
- Если A говорит, его слышат B, C, D, E
- Если B говорит, его слышат A, C, D, E
- И так далее для всех

✅ **Независимое управление** - РАБОТАЕТ
- Каждый может mute/unmute себя
- Каждый может регулировать громкость других
- Каждый может deafen себя (не слышать других)

### Ограничения текущей реализации:

❌ **Масштабирование**:
- При 10 участниках: 9 соединений на клиент - ✅ Работает нормально
- При 20 участниках: 19 соединений на клиент - ⚠️ Начинаются проблемы
- При 50 участниках: 49 соединений на клиент - ❌ Не работает
- При 100 участниках: 99 соединений на клиент - ❌ Невозможно

❌ **Ресурсы клиента**:
- CPU: ~10% при 5 участниках, ~50% при 20, ~99% при 50+
- Память: ~50MB при 5, ~200MB при 20, ~500MB+ при 50+
- Сеть: ~250 kbps при 5, ~1 Mbps при 20, ~2.5+ Mbps при 50+

❌ **Проблемы с NAT**:
- Множественные соединения усложняют NAT traversal
- Некоторые участники могут не подключиться из-за ограничений NAT

### Когда это работает хорошо:

✅ **Малые группы (2-10 участников)**:
- Отличная производительность
- Низкая задержка
- Минимальное использование ресурсов

✅ **Средние группы (10-20 участников)**:
- Работает, но начинаются проблемы
- Высокая нагрузка на CPU
- Возможны задержки

### Когда это НЕ работает:

❌ **Большие группы (20+ участников)**:
- Высокая нагрузка на клиентов
- Проблемы с производительностью
- Возможны обрывы соединений

❌ **Очень большие группы (50+ участников)**:
- Практически невозможно
- Браузеры могут зависнуть
- Соединения не устанавливаются

## Вывод:

**Текущая реализация УЖЕ поддерживает одновременное общение с несколькими участниками!**

- ✅ 1 человек может общаться с 5 участниками - **РАБОТАЕТ ОТЛИЧНО**
- ✅ 1 человек может общаться с 10 участниками - **РАБОТАЕТ**
- ⚠️ 1 человек может общаться с 20 участниками - **РАБОТАЕТ, НО С ПРОБЛЕМАМИ**
- ❌ 1 человек может общаться с 50+ участниками - **НЕ РАБОТАЕТ**

**Для масштабирования до 100+ участников нужен переход на SFU архитектуру** (см. `SCALING_TO_100_PLUS_PARTICIPANTS.md`)

