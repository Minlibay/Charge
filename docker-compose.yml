services:
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    working_dir: /app
    volumes:
      - ./backend:/app
      - ./.env:/app/.env:ro
    env_file:
      - ./.env
    environment:
      - REALTIME_REDIS_URL=redis://redis:6379/0
      - REALTIME_NATS_URL=nats://nats:4222
    depends_on:
      - db
      - redis
      - nats
    ports:
      - "8000:8000"

  db:
    image: mariadb:11.3
    restart: always
    environment:
      - MARIADB_USER=charge
      - MARIADB_PASSWORD=charge
      - MARIADB_ROOT_PASSWORD=rootpassword
      - MARIADB_DATABASE=charge
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt

  certbot:
    image: certbot/certbot:latest
    volumes:
     - ./certbot/www:/var/www/certbot
     - ./certbot/conf:/etc/letsencrypt

  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nats:
    image: nats:2.10-alpine
    restart: always
    command: ["-js", "-sd", "/data"]
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data

  turn:
    image: coturn/coturn:4.5
    network_mode: host    # проще с портами; можно и без host, но тогда явно map'ить порты
    command:
      # Provide WEBRTC_TURN_CREDENTIAL via `.env.local` or an external secret manager.
      - --lt-cred-mech
      - --no-cli
      - --no-stdout-log
      - --listening-port=3478
      - --tls-listening-port=5349
      - --fingerprint
      - --realm=${WEBRTC_TURN_REALM:-charvi.ru}
      - --user=${WEBRTC_TURN_USERNAME:-charge}:${WEBRTC_TURN_CREDENTIAL}
      - --cert=/etc/letsencrypt/live/charvi.ru/fullchain.pem
      - --pkey=/etc/letsencrypt/live/charvi.ru/privkey.pem
      - --cipher-list="ALL:!aNULL:!eNULL:!EXPORT:!DES:!SSLv2:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA"
      - --dh2066
      - --no-tcp-relay          # можно включить при необходимости
      - --min-port=30000
      - --max-port=40000
    volumes:
      - ./certbot/conf:/etc/letsencrypt:ro

volumes:
  db_data:
  redis_data:
  nats_data:
