services:
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    working_dir: /app
    volumes:
      - ./backend:/app
      - ./.env:/app/.env:ro
    env_file:
      - ./.env
    environment:
      - REALTIME_REDIS_URL=redis://redis:6379/0
      - REALTIME_NATS_URL=nats://nats:4222
    depends_on:
      - db
      - redis
      - nats
    ports:
      - "8000:8000"

  db:
    image: mariadb:11.3
    restart: always
    environment:
      - MARIADB_USER=charge
      - MARIADB_PASSWORD=charge
      - MARIADB_ROOT_PASSWORD=rootpassword
      - MARIADB_DATABASE=charge
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt

  certbot:
    image: certbot/certbot:latest
    volumes:
     - ./certbot/www:/var/www/certbot
     - ./certbot/conf:/etc/letsencrypt

  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nats:
    image: nats:2.10-alpine
    restart: always
    command: ["-js", "-sd", "/data"]
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data

  turn:
    image: coturn/coturn:4.6.2
    restart: unless-stopped
    network_mode: host
    environment:
      # эти 4 переменные ДОЛЖНЫ быть заданы (см. .env ниже)
      TURN_REALM: charvi.ru
      TURN_EXTERNAL_IP: 45.144.66.105     # публичный IP твоего сервера
      TURN_USERNAME: charge               # логин для TURN
      TURN_PASSWORD: ${WEBRTC_TURN_PASSWORD}
      TURN_MIN_PORT: 49160
      TURN_MAX_PORT: 49200
    volumes:
      - ./certbot/conf:/certs:ro
    command: >
      turnserver
      --no-cli
      --log-file=stdout
      --fingerprint
      --realm=${TURN_REALM}
      --external-ip=${TURN_EXTERNAL_IP}
      --listening-port=3478
      --tls-listening-port=5349
      --min-port=${TURN_MIN_PORT}
      --max-port=${TURN_MAX_PORT}
      --lt-cred-mech
      --user=${TURN_USERNAME}:${WEBRTC_TURN_PASSWORD}
      --cert=/certs/live/charvi.ru/fullchain.pem
      --pkey=/certs/live/charvi.ru/privkey.pem

  sfu:
    build:
      context: ./sfu-server
      dockerfile: Dockerfile
    working_dir: /app
    volumes:
      - ./.env:/app/.env:ro
    env_file:
      - ./.env
    environment:
      - SFU_HOST=0.0.0.0
      - SFU_PORT=3000
      - SFU_WS_PORT=3001
      - SFU_ANNOUNCED_IP=45.144.66.105
      - SFU_RTC_MIN_PORT=40000
      - SFU_RTC_MAX_PORT=49999
      - SFU_API_KEY=${SFU_API_KEY:-default-key-change-in-production}
      - SFU_CORS_ORIGIN=http://localhost:80,https://charvi.ru
    ports:
      - "3000:3000"  # REST API
      - "3001:3001"  # WebSocket
      - "40000-49999:40000-49999/udp"  # RTP ports
    depends_on:
      - api
    restart: unless-stopped

volumes:
  db_data:
  redis_data:
  nats_data:
