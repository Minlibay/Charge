services:
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    working_dir: /app
    volumes:
      - ./backend:/app
      - ./.env:/app/.env:ro
    env_file:
      - ./.env
    environment:
      - REALTIME_REDIS_URL=redis://redis:6379/0
      - REALTIME_NATS_URL=nats://nats:4222
    depends_on:
      - db
      - redis
      - nats
    ports:
      - "8000:8000"

  db:
    image: mariadb:11.3
    restart: always
    environment:
      - MARIADB_USER=charge
      - MARIADB_PASSWORD=charge
      - MARIADB_ROOT_PASSWORD=rootpassword
      - MARIADB_DATABASE=charge
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt

  certbot:
    image: certbot/certbot:latest
    volumes:
     - ./certbot/www:/var/www/certbot
     - ./certbot/conf:/etc/letsencrypt

  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nats:
    image: nats:2.10-alpine
    restart: always
    command: ["-js", "-sd", "/data"]
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data

  turn:
    build:
      context: .
      dockerfile: docker/turnserver/Dockerfile
    network_mode: host
    environment:
      TURN_REALM: ${WEBRTC_TURN_REALM:-charvi.ru}
      TURN_USER: ${WEBRTC_TURN_USERNAME:-charge}
      TURN_PASSWORD: ${WEBRTC_TURN_CREDENTIAL}
      TURN_CERT_FILE: /certs/live/charvi.ru/fullchain.pem
      TURN_KEY_FILE: /certs/live/charvi.ru/privkey.pem
      TURN_EXTERNAL_IP: ${WEBRTC_TURN_EXTERNAL_IP:-}
    volumes:
      - ./certbot/conf:/certs:ro

volumes:
  db_data:
  redis_data:
  nats_data:
